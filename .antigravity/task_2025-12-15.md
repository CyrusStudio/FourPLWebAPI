# 檔案交換功能整合任務

## 目標
將 sFTPDataExchange Console 應用程式功能優化後整合至 FourPLWebAPI 專案

## 任務清單

### 階段一：基礎設施擴展
- [x] 建立 `INetworkDiskHelper` 介面
- [x] 實作 `NetworkDiskHelper`：網路磁碟連線管理
- [x] 建立 `IEmailHelper` 介面
- [x] 實作 `EmailHelper`：郵件通知服務

### 階段二：檔案交換服務
- [x] 建立 `ISftpConnectionFactory`：多伺服器連線支援
- [x] 建立 `IDataExchangeService` 介面
- [x] 實作 `DataExchangeService`：檔案交換核心邏輯
- [x] 建立 API Controller

### 階段三：排程整合
- [ ] 建立 `DataExchangeJob`：Hangfire 排程任務 (待後續整合)
- [x] 更新 `appsettings.json`：新增設定區段

### 階段四：驗證
- [x] 建置專案確認無編譯錯誤
- [ ] 撰寫單元測試 (待後續)

### 階段五：SAP 檔案後處理
- [x] 更新設定檔：新增 Success/Fail 資料夾路徑
- [x] 建立 `ISapFileProcessor` 介面
- [x] 實作 `SapFileProcessor`：四種檔案類型處理
- [x] 新增 API 端點：手動觸發後處理

### 階段六：重構 SAP 模組為獨立架構
- [x] 建立 `SapFileController`：獨立的 SAP 檔案 API
- [x] 從 `DataExchangeController` 移除 SAP 處理端點
- [x] 驗證建置
- [x] 拆分 Service 層：`SapFileProcessor` 新增 `DownloadFromSapAsync`
- [x] 更新 `SapFileController` 新增下載端點

### 階段七：實作檔案處理邏輯 ✅
- [x] 建立通用架構：`SapMasterDataAttributes` + `SapMasterDataRepository`
- [x] Customer：讀取 XML 寫入 SAPDS.Sales_CustomerMaster (26 欄位)
- [x] Material：讀取 XML 寫入 SAPDS.Sales_MaterialMaster (23 欄位)
- [x] Price：讀取 XML 寫入 SAPDS.Sales_PriceMaster (24 欄位)
- [x] Sales：讀取 XML 寫入 SAPDS.Sales_SalesMaster (11 欄位)

### 階段八：清理重構後未使用程式碼 ✅
- [x] 刪除 `CustomerMasterRepository.cs` (已被通用 Repository 取代)
- [x] 移除 `DataExchangeService.DownloadFromSapAsync` (重複功能)
- [x] 移除 `DataExchangeService.ExecuteAllAsync` (待之後設計)
- [x] 移除 `DataExchangeController` 對應端點

### 階段九：程式碼優化 ✅
- [x] 消除重複處理方法：合併四個 ProcessXxxFileAsync 為泛型 `ProcessFileAsync<T>`
- [x] 減少約 100 行重複程式碼
- [x] 快取反射結果：使用 `ConcurrentDictionary` 快取屬性對應、SQL 語句、Attribute
